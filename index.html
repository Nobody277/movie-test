<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Embed Player with HLS & Cast</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script>console.log('Version 1.3');</script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
  <style>
    :root { --bg: #f2f2f2; --fg: #333; --accent: #0066ff; --input-bg: #fff; --input-border: #ccc; --card-shadow: rgba(0,0,0,0.1); --cast-button-color: #333; }
    [data-theme="dark"] { --bg: #121212; --fg: #e0e0e0; --accent: #3399ff; --input-bg: #1e1e1e; --input-border: #444; --card-shadow: rgba(0,0,0,0.5); --cast-button-color: #e0e0e0; }
    @media (prefers-color-scheme: dark) {
      :root { color-scheme: light dark; }
      :root:not([data-theme]) { --bg: #121212; --fg: #e0e0e0; --accent: #3399ff; --input-bg: #1e1e1e; --input-border: #444; --card-shadow: rgba(0,0,0,0.5); --cast-button-color: #e0e0e0; }
    }
    body { margin: 0; padding: 2rem 1rem; font-family: 'Roboto', sans-serif; background: var(--bg); color: var(--fg); display: flex; flex-direction: column; align-items: center; min-height: 100vh; gap: 1.5rem; }
    #versionTag { position: fixed; top: 0.5rem; left: 0.5rem; background: rgba(0,0,0,0.5); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; z-index: 999; }
    h1 { margin: 0; font-weight: 500; text-align: center; }
    .controls { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; align-items: center; }
    input[type="text"] { padding: 0.6rem 1rem; font-size: 1rem; flex: 1 1 300px; max-width: 600px; border: 1px solid var(--input-border); border-radius: 6px; background: var(--input-bg); color: var(--fg); }
    button { padding: 0.6rem 1.2rem; font-size: 1rem; border: none; border-radius: 6px; background: var(--accent); color: #fff; cursor: pointer; transition: filter 0.2s; }
    button:hover { filter: brightness(1.1); }
    .theme-toggle { position: absolute; top: 1rem; right: 1rem; background: transparent; border: none; font-size: 1.2rem; cursor: pointer; color: var(--fg); }
    #videoContainer { width: 90vw; max-width: 1200px; box-shadow: 0 4px 16px var(--card-shadow); border-radius: 8px; overflow: hidden; }
    #videoPlayer { width: 100%; height: auto; display: block; background: #000; }
    google-cast-launcher { width: 24px; height: 24px; cursor: pointer; margin-left: 0.5rem; color: var(--cast-button-color); --cast-button-active-color: var(--accent); }
    .cast-info { font-size: 0.9em; color: var(--fg); margin-top: 0.5rem; text-align: center; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div id="versionTag">v1.3</div>
  <button class="theme-toggle" id="themeToggle">ðŸŒ“</button>
  <h1>Video Player with HLS & Cast</h1>
  <div class="controls">
    <input id="videoURL" type="text" placeholder="Paste .mp4 or .m3u8 URL hereâ€¦" aria-label="Video URL">
    <button id="loadBtn">Load Video</button>
    <google-cast-launcher id="castButton"></google-cast-launcher>
  </div>
  <div id="castInfo" class="cast-info">Initializing...</div>
  <div id="videoContainer">
    <video id="videoPlayer" controls preload="metadata" playsinline webkit-playsinline></video>
  </div>
  <script>
    const video = document.getElementById('videoPlayer');
    const loadBtn = document.getElementById('loadBtn');
    const urlInput = document.getElementById('videoURL');
    const castInfo = document.getElementById('castInfo');
    const themeToggle = document.getElementById('themeToggle');
    const root = document.documentElement;
    let hlsInstance = null;
    let currentVideo = '';

    themeToggle.onclick = () => {
      const t = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
    };
    if (localStorage.getItem('theme')) root.setAttribute('data-theme', localStorage.getItem('theme'));

    window.__onGCastApiAvailable = avail => {
      if (!avail) return castInfo.textContent = 'Cast SDK unavailable';
      initializeCast();
    };

    function initializeCast() {
      const context = cast.framework.CastContext.getInstance();
      context.setOptions({
        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.TAB_AND_ORIGIN_SCOPED
      });
      context.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, e => {
        switch (e.sessionState) {
          case cast.framework.SessionState.SESSION_STARTED:
          case cast.framework.SessionState.SESSION_RESUMED:
            castInfo.textContent = 'Connected. Loading mediaâ€¦';
            loadMedia(currentVideo);
            video.style.display = 'none';
            break;
          case cast.framework.SessionState.SESSION_ENDED:
            castInfo.textContent = 'Session ended';
            video.style.display = 'block';
            break;
          default:
            break;
        }
      });
      castInfo.textContent = 'Cast ready';
    }

    function loadMedia(url) {
      if (!url) return;
      const mediaInfo = new chrome.cast.media.MediaInfo(url, url.endsWith('.m3u8') ? 'application/x-mpegURL' : 'video/mp4');
      const request = new chrome.cast.media.LoadRequest(mediaInfo);
      cast.framework.CastContext.getInstance().getCurrentSession().loadMedia(request)
        .then(() => castInfo.textContent = 'Casting: ' + mediaInfo.contentId)
        .catch(err => castInfo.textContent = 'Cast error: ' + err.message);
    }

    loadBtn.onclick = () => {
      const url = urlInput.value.trim();
      if (!url) return;
      currentVideo = url;
      if (cast.framework.CastContext.getInstance().getSessionState() === cast.framework.SessionState.SESSION_STARTED) {
        loadMedia(url);
      } else {
        playLocal(url);
      }
    };

    function playLocal(url) {
      video.style.display = 'block';
      castInfo.textContent = 'Playing locally';
      if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
      if (url.endsWith('.m3u8') && Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.ERROR, (_e, data) => castInfo.textContent = 'HLS error: ' + data.details);
      } else {
        video.src = url;
      }
      video.play().catch(() => {});
    }

    video.addEventListener('error', () => {
      const code = video.error?.code || 0;
      const msgs = ['Unknown','Network','Decode','Not Supported','Src Missing'];
      castInfo.textContent = 'Playback Error: ' + (msgs[code] || 'Unknown');
    });
  </script>
</body>
</html>
