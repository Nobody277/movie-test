<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Night</title>
  <meta property="og:title" content="Movie Night" />
  <meta property="og:description" content="Watch movies or shows with friends you don't have!" />
  <meta property="og:image" content="https://github.com/Nobody277/movie-night/blob/main/MovieNight.png" />
  <link rel="preconnect" href="https://fonts.gstatic.com" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg: linear-gradient(135deg,#000,#2e003e);
      --fg: #e0e0e0;
      --accent:#9b00ff;
      --in-bg:#1a1a1a;
      --in-border:#3e003f;
    }
    * { box-sizing: border-box; }
    body {
      margin:0; padding:0;
      font-family:'Roboto',sans-serif;
      background:var(--bg);
      color:var(--fg);
      display:flex; height:100vh; overflow:hidden;
    }
    #videoContainer {
      flex:2; display:flex; align-items:center; justify-content:center;
      background:#000;
    }
    #videoPlayer {
      width:100%; max-width:900px; border-radius:8px;
    }
    #chatSidebar {
      flex:1; max-width:350px; background:rgba(0,0,0,0.5);
      backdrop-filter:blur(8px); display:flex; flex-direction:column;
      animation:slideIn .5s ease forwards;
    }
    #chatHeader {
      padding:1rem; font-size:1.2rem;
      border-bottom:1px solid var(--in-border);
      display:flex; justify-content:space-between;
    }
    #usernameDisplay { font-weight:500; }
    #statsPanel {
      padding:1rem; border-bottom:1px solid var(--in-border);
    }
    #statsPanel h3 { margin:0 0 .5rem; font-size:1rem; }
    #statsList {
      list-style:none; margin:0; padding:0;
      max-height:120px; overflow-y:auto; font-size:.9rem;
    }
    #statsList li { margin-bottom:.25rem; }
    #chatMessages {
      flex:1; overflow-y:auto; padding:1rem;
      display:flex; flex-direction:column; gap:.75rem;
    }
    .chatMessage {
      padding:.5rem .75rem; background:rgba(255,255,255,0.1);
      border-radius:6px; max-width:80%; animation:fadeIn .3s ease;
    }
    .chatMessage .user { font-weight:500; margin-right:.5rem; }
    #chatInputContainer {
      display:flex; padding:.75rem; border-top:1px solid var(--in-border);
    }
    #chatInput {
      flex:1; padding:.5rem .75rem;
      border:1px solid var(--in-border);
      border-radius:6px; background:var(--in-bg);
      color:var(--fg);
    }
    button {
      margin-left:.5rem; padding:.6rem 1.2rem;
      background:var(--accent); color:#fff;
      border:none; border-radius:6px; cursor:pointer;
    }
    @keyframes slideIn {
      from{transform:translateX(100%);}to{transform:translateX(0);}
    }
    @keyframes fadeIn {
      from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}
    }
  </style>
</head>
<body>
  <div id="videoContainer">
    <video id="videoPlayer" controls playsinline webkit-playsinline></video>
  </div>

  <aside id="chatSidebar">
    <div id="chatHeader">
      <span>Chat</span>
      <span id="usernameDisplay"></span>
    </div>
    <div id="statsPanel">
      <h3>Participants</h3>
      <ul id="statsList"></ul>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputContainer">
      <input id="chatInput" placeholder="Type a message…" />
      <button id="sendBtn">Send</button>
    </div>
  </aside>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      const isMobile = /Mobi|Android|iPhone/.test(navigator.userAgent);

      // random Guest #n
      const username = `Guest #${Math.floor(Math.random()*1000)+1}`;
      document.getElementById('usernameDisplay').textContent = username;

      // sync settings
      const SYNC_INTERVAL=1000, HARD_THRESHOLD=1.0, NUDGE=0.1,
            MIN_RATE=0.95, MAX_RATE=1.05;

      let hls, currentSrc='', latency=0, initState=null;
      let supSeek=false, supPlay=false, supPause=false;

      // UI refs
      const player = document.getElementById('videoPlayer');
      const statsList = document.getElementById('statsList');
      const chatMsgs = document.getElementById('chatMessages');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');

      const params = new URLSearchParams(location.search);
      const roomId = params.get('room');
      if (!roomId) {
        chatMsgs.innerHTML = '<em>No room specified.</em>';
        return;
      }
      socket.emit('joinRoom', { roomId, username });

      // latency ping/pong
      function ping() {
        const t0=Date.now();
        socket.emit('pingCheck',{clientTime:t0});
      }
      socket.on('pongCheck',({clientTime})=>{
        latency=(Date.now()-clientTime)/2;
      });

      // chat helpers
      function appendMsg(user,text){
        const d=document.createElement('div');
        d.className='chatMessage';
        d.innerHTML=`<span class="user">${user}:</span> ${text}`;
        chatMsgs.append(d);
        chatMsgs.scrollTop=chatMsgs.scrollHeight;
      }
      function fmtTime(s){
        const m=Math.floor(s/60), sec=Math.floor(s%60).toString().padStart(2,'0');
        return `${m}:${sec}`;
      }

      // outgoing chat
      sendBtn.addEventListener('click',()=>{
        const t=chatInput.value.trim();
        if(!t) return;
        appendMsg(username,t);
        socket.emit('chat',{roomId,msg:t,username});
        chatInput.value='';
      });
      socket.on('chat',data=>appendMsg(data.username,data.msg));

      // stats
      socket.on('stats',arr=>{
        statsList.innerHTML='';
        arr.forEach(p=>{
          const li=document.createElement('li');
          li.textContent=`${p.username} | ${p.platform} | ${Math.round(p.latency)} ms | ${fmtTime(p.time)}`;
          statsList.append(li);
        });
      });

      // init state
      socket.on('init',state=>{
        initState=state;
        if(state.videoUrl!==currentSrc){
          currentSrc=state.videoUrl;
          if(hls){ hls.destroy(); hls=null; }
          if(currentSrc.endsWith('.m3u8') && Hls.isSupported()){
            hls=new Hls();
            hls.loadSource(currentSrc);
            hls.attachMedia(player);
          } else {
            player.src=currentSrc;
          }
        }
        ping();
        player.pause();
        player.addEventListener('canplay',()=>{
          const now=Date.now();
          const elapsed=(now - initState.lastUpdate - latency)/1000;
          const target=initState.currentTime + (initState.paused?0:elapsed);
          supSeek=true; player.currentTime=target;
          if(initState.paused){ supPause=true; player.pause(); }
          else          { supPlay=true;  player.play(); }
          setupSync(); startSync();
          setInterval(()=>{
            socket.emit('statsUpdate',{
              username,
              latency,
              time:player.currentTime,
              platform: isMobile?'mobile':'desktop'
            });
          },1000);
        },{once:true});
      });

      function setupSync(){
        player.addEventListener('seeked',()=>{
          if(supSeek){ supSeek=false; return; }
          initState.currentTime=player.currentTime;
          initState.lastUpdate=Date.now();
          socket.emit('seek',{roomId,time:player.currentTime});
        });
        player.addEventListener('play',()=>{
          if(supPlay){ supPlay=false; return; }
          initState.currentTime=player.currentTime;
          initState.lastUpdate=Date.now();
          initState.paused=false;
          socket.emit('play',{roomId,time:player.currentTime});
        });
        player.addEventListener('pause',()=>{
          if(supPause){ supPause=false; return; }
          initState.currentTime=player.currentTime;
          initState.lastUpdate=Date.now();
          initState.paused=true;
          socket.emit('pause',{roomId,time:player.currentTime});
        });

        socket.on('play',d=>{
          initState.currentTime=d.time;
          initState.paused=false;
          initState.lastUpdate=Date.now();
          supPlay=true; player.play();
        });
        socket.on('pause',d=>{
          initState.currentTime=d.time;
          initState.paused=true;
          initState.lastUpdate=Date.now();
          supPause=true; player.pause();
        });
        socket.on('seek',d=>{
          initState.currentTime=d.time;
          initState.lastUpdate=Date.now();
          supSeek=true; player.currentTime=d.time;
        });
      }

      function startSync(){
        if(isMobile) return;
        setInterval(()=>{
          const now=Date.now();
          const elapsed=(now - initState.lastUpdate - latency)/1000;
          const serverTime=initState.currentTime + (initState.paused?0:elapsed);
          const diff=serverTime - player.currentTime;
          if(Math.abs(diff)>HARD_THRESHOLD){
            supSeek=true; player.currentTime=serverTime;
          } else {
            player.playbackRate=Math.min(
              MAX_RATE, Math.max(MIN_RATE,1+diff*NUDGE)
            );
          }
        },SYNC_INTERVAL);

        setInterval(()=>{ socket.emit('getState',{roomId}); },SYNC_INTERVAL*5);

        socket.on('syncState',s=>{
          initState.currentTime=s.currentTime;
          initState.paused=s.paused;
          initState.lastUpdate=s.lastUpdate;
          if(s.paused !== player.paused){
            if(s.paused){ supPause=true; player.pause(); }
            else         { supPlay=true;  player.play(); }
          }
        });
      }
    });
  </script>
</body>
</html>