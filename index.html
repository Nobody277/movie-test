<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Movie Night</title>
  <meta property="og:title" content="Movie Night">
  <meta property="og:description" content="Watch movies or shows with friends you don't have!">
  <meta property="og:image" content="https://github.com/Nobody277/movie-night/blob/main/MovieNight.png">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.socket.io/4.7.1/socket.io.min.js" crossorigin="anonymous"></script>
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg,#000,#2e003e);
      --fg: #e0e0e0;
      --accent: #9b00ff;
      --input-bg: #1a1a1a;
      --input-border: #3e003f;
      --card-shadow: rgba(0,0,0,0.7);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
      background: var(--bg-gradient);
      color: var(--fg);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #mainContent {
      display: flex;
      flex: 1;
    }
    #videoSection {
      flex: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      position: relative;
    }
    #videoContainer {
      width: 100%;
      max-width: 900px;
      box-shadow: 0 4px 16px var(--card-shadow);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    #videoPlayer {
      width: 100%;
      height: auto;
      background: #000;
    }
    #syncOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      display: none;
    }
    #joinSyncBtn {
      padding: 1rem 2rem;
      font-size: 1.2rem;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
    }
    #controls {
      margin-top: 1rem;
      display: flex;
      gap: .5rem;
    }
    #videoURL {
      flex: 1;
      max-width: 600px;
      padding: .6rem 1rem;
      font-size: 1rem;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--fg);
    }
    button {
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      transition: transform .2s;
      padding: .6rem 1.2rem;
    }
    button:hover {
      transform: scale(1.05);
    }
    #chatSidebar {
      position: relative;
      flex: 1;
      max-width: 350px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      animation: slideIn 1s ease forwards;
    }
    #chatHeader {
      padding: 1rem;
      font-size: 1.2rem;
      border-bottom: 1px solid var(--input-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #usernameDisplay {
      font-weight: 500;
    }
    #chatMessages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }
    .chatMessage {
      padding: .5rem .75rem;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      max-width: 80%;
      animation: fadeIn .5s ease;
    }
    .chatMessage .user {
      font-weight: 500;
      margin-right: .5rem;
    }
    #chatInputContainer {
      display: flex;
      padding: .75rem;
      border-top: 1px solid var(--input-border);
    }
    #chatInput {
      flex: 1;
      padding: .5rem .75rem;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--fg);
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity .3s ease;
    }
    .modal.visible {
      opacity: 1;
      pointer-events: auto;
    }
    .modalBox {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 16px var(--card-shadow);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .modalHeader {
      font-size: 1.25rem;
    }
    .modalBox input {
      width: 100%;
      padding: .6rem 1rem;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--fg);
    }
    .modalActions {
      display: flex;
      justify-content: flex-end;
      gap: .5rem;
    }
    #userPrompt {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.85);
      padding: 1rem;
      display: none;
      align-items: center;
      gap: .5rem;
    }
    #userPrompt.visible {
      display: flex;
    }
    #userPrompt input {
      flex: 1;
      padding: .5rem .75rem;
      border: 1px solid var(--input-border);
      border-radius: 6px;
      background: var(--input-bg);
      color: var(--fg);
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to   { transform: translateX(0);       }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0);     }
    }
  </style>
</head>
<body>
  <div id="mainContent">
    <section id="videoSection">
      <div id="videoContainer">
        <video id="videoPlayer" controls playsinline webkit-playsinline></video>
        <div id="syncOverlay">
          <button id="joinSyncBtn">Click to join</button>
        </div>
      </div>
      <div id="controls">
        <input id="videoURL" placeholder="Paste URL…" />
        <button id="loadBtn">Load Video</button>
        <button id="createRoom">Create Room</button>
      </div>
    </section>

    <aside id="chatSidebar">
      <div id="chatHeader">
        <span>Chat</span>
        <span id="usernameDisplay"></span>
      </div>
      <div id="chatMessages"></div>
      <div id="chatInputContainer">
        <input id="chatInput" placeholder="Type a message…" />
        <button id="sendBtn">Send</button>
      </div>
      <div id="userPrompt">
        <input id="usernameInput" placeholder="Enter username…" />
        <button id="setUser">OK</button>
      </div>
    </aside>
  </div>

  <div id="shareModal" class="modal">
    <div class="modalBox">
      <div class="modalHeader">Room Link</div>
      <input id="shareURL" readonly />
      <div class="modalActions">
        <button id="copyBtn">Copy</button>
        <button id="closeModal">Close</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const SOCKET_SERVER_URL = 'https://movie-night-backend-dvp8.onrender.com';
      const FRONTEND_LINK     = `${location.origin}${location.pathname}`;
      const socket            = io(SOCKET_SERVER_URL);

      // drift sync parameters
      const SYNC_INTERVAL   = 5000;
      const SNAP_THRESHOLD  = 1.0;
      const NUDGE_THRESHOLD = 0.05;
      const MAX_NUDGE_RATE  = 1.03;
      const MIN_NUDGE_RATE  = 0.97;

      let hls;
      let currentSource = '';
      let username = '';
      let suppressSync = false;
      let initState;

      const params = new URLSearchParams(location.search);
      const inRoom = params.has('room');
      const roomId = params.get('room');

      // UI references
      const player          = document.getElementById('videoPlayer');
      const loadBtn         = document.getElementById('loadBtn');
      const createBtn       = document.getElementById('createRoom');
      const chatMsgs        = document.getElementById('chatMessages');
      const chatInput       = document.getElementById('chatInput');
      const sendBtn         = document.getElementById('sendBtn');
      const usernameDisplay = document.getElementById('usernameDisplay');
      const userPrompt      = document.getElementById('userPrompt');
      const usernameInput   = document.getElementById('usernameInput');
      const setUserBtn      = document.getElementById('setUser');
      const overlay         = document.getElementById('syncOverlay');
      const joinBtn         = document.getElementById('joinSyncBtn');

      // Load or reload video source
      function loadVideo(url) {
        if (hls) { hls.destroy(); hls = null; }
        player.src = '';
        if (url.endsWith('.m3u8') && Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(url);
          hls.attachMedia(player);
        } else {
          player.src = url;
        }
      }

      // Set username once entered
      setUserBtn.addEventListener('click', () => {
        const v = usernameInput.value.trim();
        if (!v) return;
        username = v;
        usernameDisplay.textContent = v;
        userPrompt.classList.remove('visible');
      });

      // Manual load button
      loadBtn.addEventListener('click', () => {
        const url = document.getElementById('videoURL').value.trim();
        if (!url) return;
        currentSource = url;
        loadVideo(url);
        player.play().catch(() => {});
      });

      // Create room via backend
      createBtn.addEventListener('click', async () => {
        const src = currentSource || document.getElementById('videoURL').value.trim();
        if (!src) return;
        try {
          const res = await fetch(`${SOCKET_SERVER_URL}/rooms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ videoUrl: src })
          });
          const { roomId } = await res.json();
          const link = `${FRONTEND_LINK}?room=${roomId}`;
          document.getElementById('shareURL').value = link;
          document.getElementById('shareModal').classList.add('visible');
        } catch (e) {
          console.error('Could not create room', e);
        }
      });

      // Safe emit to prevent feedback loops
      function safeEmit(event, data) {
        if (!suppressSync) socket.emit(event, data);
      }

      // Append chat message
      function appendMessage(user, text) {
        const el = document.createElement('div');
        el.className = 'chatMessage';
        el.innerHTML = `<span class="user">${user}:</span> ${text}`;
        chatMsgs.append(el);
        chatMsgs.scrollTop = chatMsgs.scrollHeight;
      }

      // Handle initial join
      if (inRoom) {
        createBtn.style.display = 'none';
        socket.emit('joinRoom', { roomId });

        // Receive initial room state
        socket.on('init', state => {
          initState = state;
          if (state.videoUrl !== currentSource) {
            currentSource = state.videoUrl;
            loadVideo(state.videoUrl);
          }
          // Pause and show overlay until fully synced
          player.pause();
          overlay.style.display = 'flex';
        });

        // User clicks to join when ready
        joinBtn.addEventListener('click', () => {
          socket.emit('readyToSync', { roomId });
        });

        // Server signals when to start sync for this client
        socket.on('startSync', () => {
          const { currentTime, paused, lastUpdate } = initState;
          let target = currentTime;
          if (!paused) {
            const drift = (Date.now() - lastUpdate) / 1000;
            target += drift;
          }
          player.currentTime = target;
          if (!paused) player.play();
          overlay.style.display = 'none';
          setupSync();
        });
      }

      // After agreed start, bind all sync/chat logic
      function setupSync() {
        // Relay local controls
        ['play', 'pause', 'seeked'].forEach(evt => {
          player.addEventListener(evt, () => {
            const time = player.currentTime;
            const emitEvt = evt === 'seeked' ? 'seek' : evt;
            safeEmit(emitEvt, { roomId, time });
          });
        });

        // Apply remote control events
        socket.on('play', data => {
          suppressSync = true;
          player.currentTime = data.time;
          player.play();
          setTimeout(() => (suppressSync = false), 200);
        });
        socket.on('pause', data => {
          suppressSync = true;
          player.currentTime = data.time;
          player.pause();
          setTimeout(() => (suppressSync = false), 200);
        });
        socket.on('seek', data => {
          suppressSync = true;
          player.currentTime = data.time;
          setTimeout(() => (suppressSync = false), 200);
        });

        // Chat send
        sendBtn.addEventListener('click', () => {
          const msg = chatInput.value.trim();
          if (!msg) return;
          if (!username) {
            userPrompt.classList.add('visible');
            return;
          }
          safeEmit('chat', { roomId, msg, username });
          appendMessage(username, msg);
          chatInput.value = '';
        });
        socket.on('chat', data => appendMessage(data.username, data.msg));

        // Drift correction listener
        socket.on('syncState', resyncState);
        setInterval(() => socket.emit('getState', { roomId }), SYNC_INTERVAL);
      }

      // Drift correction logic
      function resyncState({ currentTime, paused, lastUpdate }) {
        if (paused) {
          // Snap to pause position if needed
          const diff = Math.abs(player.currentTime - currentTime);
          if (diff > NUDGE_THRESHOLD) {
            suppressSync = true;
            player.currentTime = currentTime;
            setTimeout(() => (suppressSync = false), 200);
          }
          player.pause();
          return;
        }

        const drift = (Date.now() - lastUpdate) / 1000;
        const target = currentTime + drift;
        const local = player.currentTime;
        const diff = target - local;

        if (Math.abs(diff) > SNAP_THRESHOLD) {
          // Hard snap
          suppressSync = true;
          player.currentTime = target;
          player.playbackRate = 1.0;
          setTimeout(() => (suppressSync = false), 200);
        } else if (Math.abs(diff) > NUDGE_THRESHOLD) {
          // Gentle nudge
          const rate = 1 + Math.sign(diff) * 0.02;
          player.playbackRate = Math.min(MAX_NUDGE_RATE, Math.max(MIN_NUDGE_RATE, rate));
        } else {
          player.playbackRate = 1.0;
        }
        player.play();
      }
    });
  </script>
</body>
</html>